<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interview Proctoring System - Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .status {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: #ecf0f1;
            border-radius: 5px;
        }

        .status-item {
            flex: 1;
            text-align: center;
        }

        .status-item h3 {
            margin: 0 0 5px 0;
            color: #34495e;
        }

        .video-container {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .video-section {
            flex: 2;
        }

        .events-section {
            flex: 1;
        }

        video {
            width: 100%;
            height: 300px;
            border-radius: 8px;
            border: 3px solid #3498db;
            background: #000;
        }

        .controls {
            margin: 15px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .events-log {
            height: 300px;
            overflow-y: auto;
            border: 2px solid #bdc3c7;
            border-radius: 5px;
            padding: 10px;
            background: #fff;
        }

        .event {
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            border-left: 4px solid #95a5a6;
        }

        .event.info {
            background: #d5f4e6;
            border-left-color: #27ae60;
        }

        .event.warning {
            background: #fff3cd;
            border-left-color: #ffc107;
        }

        .event.suspicious {
            background: #f8d7da;
            border-left-color: #dc3545;
        }

        .event.error {
            background: #f8d7da;
            border-left-color: #dc3545;
        }

        .event-time {
            font-weight: bold;
            color: #666;
        }

        .integrity-score {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }

        .integrity-high {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .integrity-medium {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .integrity-low {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .candidate-input {
            margin-bottom: 20px;
        }

        .candidate-input input {
            width: 100%;
            padding: 10px;
            border: 2px solid #bdc3c7;
            border-radius: 5px;
            font-size: 16px;
        }

        .candidate-input input:focus {
            outline: none;
            border-color: #3498db;
        }

        .hidden {
            display: none;
        }

        canvas {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Interview Proctoring System</h1>
            <p>Real-time monitoring for interview integrity</p>
        </div>

        <div class="candidate-input">
            <input type="text" id="candidateName" placeholder="Enter candidate name" />
        </div>

        <div class="status">
            <div class="status-item">
                <h3>Interview Status</h3>
                <span id="interviewStatus">Not Started</span>
            </div>
            <div class="status-item">
                <h3>Duration</h3>
                <span id="interviewDuration">00:00:00</span>
            </div>
            <div class="status-item">
                <h3>Events</h3>
                <span id="eventCount">0</span>
            </div>
        </div>

        <div class="video-container">
            <div class="video-section">
                <video id="webcamVideo" autoplay muted playsinline>
                    <p>Your browser doesn't support video streaming</p>
                </video>
                <canvas id="detectionCanvas"></canvas>
                
                <div class="controls">
                    <button id="startBtn" class="btn-primary">Start Interview</button>
                    <button id="stopBtn" class="btn-danger hidden">Stop Interview</button>
                    <button id="recordBtn" class="btn-success hidden">Start Recording</button>
                    <button id="stopRecordBtn" class="btn-danger hidden">Stop Recording</button>
                    <button id="downloadBtn" class="btn-success hidden">Download Recording</button>
                </div>
            </div>

            <div class="events-section">
                <h3>Event Log</h3>
                <div id="eventsLog" class="events-log"></div>
                
                <div id="integrityScore" class="integrity-score integrity-high">
                    Integrity Score: 100%
                </div>

                <div class="controls">
                    <button id="generateReportBtn" class="btn-primary">Generate Report</button>
                    <button id="downloadCSVBtn" class="btn-success">Download CSV</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let mediaStream = null;
        let mediaRecorder = null;
        let recordedChunks = [];
        let isInterviewActive = false;
        let interviewStartTime = null;
        let events = [];
        let integrityScore = 100;
        let detectionInterval = null;
        let durationInterval = null;

        // DOM elements
        const webcamVideo = document.getElementById('webcamVideo');
        const detectionCanvas = document.getElementById('detectionCanvas');
        const candidateNameInput = document.getElementById('candidateName');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const recordBtn = document.getElementById('recordBtn');
        const stopRecordBtn = document.getElementById('stopRecordBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const eventsLog = document.getElementById('eventsLog');
        const interviewStatus = document.getElementById('interviewStatus');
        const interviewDuration = document.getElementById('interviewDuration');
        const eventCount = document.getElementById('eventCount');
        const integrityScoreElement = document.getElementById('integrityScore');
        const generateReportBtn = document.getElementById('generateReportBtn');
        const downloadCSVBtn = document.getElementById('downloadCSVBtn');

        // Initialize webcam
        async function initializeWebcam() {
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'
                    },
                    audio: true
                });
                webcamVideo.srcObject = mediaStream;
                addEvent('Webcam initialized successfully', 'info');
            } catch (error) {
                addEvent('Failed to access webcam: ' + error.message, 'error');
            }
        }

        // Add event to log
        function addEvent(message, type = 'info') {
            const timestamp = new Date();
            const event = {
                time: timestamp.toISOString(),
                event: message,
                type: type,
                timestamp: timestamp
            };
            
            events.push(event);
            
            // Update integrity score for suspicious events
            if (type === 'suspicious' || type === 'warning') {
                integrityScore = Math.max(0, integrityScore - 5);
                updateIntegrityScore();
            }

            updateEventsLog();
            updateEventCount();
        }

        // Update events log display
        function updateEventsLog() {
            eventsLog.innerHTML = events.slice(-20).map(event => `
                <div class="event ${event.type}">
                    <span class="event-time">${event.timestamp.toLocaleTimeString()}</span>
                    <div>${event.event}</div>
                </div>
            `).join('');
            eventsLog.scrollTop = eventsLog.scrollHeight;
        }

        // Update event count
        function updateEventCount() {
            eventCount.textContent = events.length;
        }

        // Update integrity score display
        function updateIntegrityScore() {
            integrityScoreElement.textContent = `Integrity Score: ${integrityScore}%`;
            
            // Update score color
            integrityScoreElement.className = 'integrity-score';
            if (integrityScore >= 80) {
                integrityScoreElement.classList.add('integrity-high');
            } else if (integrityScore >= 60) {
                integrityScoreElement.classList.add('integrity-medium');
            } else {
                integrityScoreElement.classList.add('integrity-low');
            }
        }

        // Face detection function
        function detectFace() {
            if (!webcamVideo.videoWidth) return;

            const canvas = detectionCanvas;
            const ctx = canvas.getContext('2d');
            canvas.width = webcamVideo.videoWidth;
            canvas.height = webcamVideo.videoHeight;
            
            ctx.drawImage(webcamVideo, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // Simple face detection based on skin color
            let skinPixels = 0;
            let totalPixels = 0;
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const regionSize = Math.min(canvas.width, canvas.height) * 0.3;
            
            for (let y = centerY - regionSize/2; y < centerY + regionSize/2; y += 4) {
                for (let x = centerX - regionSize/2; x < centerX + regionSize/2; x += 4) {
                    if (y >= 0 && y < canvas.height && x >= 0 && x < canvas.width) {
                        const index = (Math.floor(y) * canvas.width + Math.floor(x)) * 4;
                        const r = data[index];
                        const g = data[index + 1];
                        const b = data[index + 2];
                        
                        // Skin color detection
                        if (r > 95 && g > 40 && b > 20 && 
                            Math.max(r, g, b) - Math.min(r, g, b) > 15 &&
                            Math.abs(r - g) > 15 && r > g && r > b) {
                            skinPixels++;
                        }
                        totalPixels++;
                    }
                }
            }
            
            const skinRatio = skinPixels / totalPixels;
            
            if (skinRatio < 0.1) {
                addEvent(' No face detected', 'warning');
            } else if (skinRatio > 0.25) {
                // Check for multiple faces randomly for demo
                if (Math.random() < 0.1) {
                    addEvent(' Multiple faces detected', 'suspicious');
                }
            }
        }

        // Object detection function
        function detectObjects() {
            if (!webcamVideo.videoWidth) return;

            // Simulate object detection for demo
            if (Math.random() < 0.05) { // 5% chance per scan
                const objects = ['cell phone', 'book', 'laptop'];
                const randomObject = objects[Math.floor(Math.random() * objects.length)];
                const confidence = (60 + Math.random() * 30).toFixed(1);
                addEvent(`üö® Unauthorized object detected: ${randomObject} (${confidence}% confidence)`, 'suspicious');
            }
        }

        // Start interview
        function startInterview() {
            if (!candidateNameInput.value.trim()) {
                alert('Please enter candidate name');
                return;
            }

            isInterviewActive = true;
            interviewStartTime = new Date();
            
            // Update UI
            startBtn.classList.add('hidden');
            stopBtn.classList.remove('hidden');
            recordBtn.classList.remove('hidden');
            candidateNameInput.disabled = true;
            interviewStatus.textContent = 'Active';
            
            // Start monitoring
            detectionInterval = setInterval(() => {
                detectFace();
                detectObjects();
            }, 3000);

            // Start duration timer
            durationInterval = setInterval(updateDuration, 1000);
            
            addEvent(`Interview started for ${candidateNameInput.value}`, 'info');
            addEvent('Face detection monitoring started', 'info');
            addEvent('Advanced object detection system initialized', 'info');
        }

        // Stop interview
        function stopInterview() {
            isInterviewActive = false;
            
            // Update UI
            startBtn.classList.remove('hidden');
            stopBtn.classList.add('hidden');
            recordBtn.classList.add('hidden');
            stopRecordBtn.classList.add('hidden');
            candidateNameInput.disabled = false;
            interviewStatus.textContent = 'Completed';
            
            // Stop monitoring
            if (detectionInterval) {
                clearInterval(detectionInterval);
                detectionInterval = null;
            }
            
            if (durationInterval) {
                clearInterval(durationInterval);
                durationInterval = null;
            }

            // Stop recording if active
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                stopRecording();
            }
            
            addEvent('Interview session ended', 'info');
        }

        // Update duration display
        function updateDuration() {
            if (!interviewStartTime) return;
            
            const now = new Date();
            const duration = now - interviewStartTime;
            
            const hours = Math.floor(duration / 3600000);
            const minutes = Math.floor((duration % 3600000) / 60000);
            const seconds = Math.floor((duration % 60000) / 1000);
            
            interviewDuration.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Start recording
        function startRecording() {
            if (!mediaStream) return;
            
            recordedChunks = [];
            mediaRecorder = new MediaRecorder(mediaStream, {
                mimeType: 'video/webm;codecs=vp9,opus'
            });
            
            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };
            
            mediaRecorder.onstop = () => {
                const blob = new Blob(recordedChunks, { type: 'video/webm' });
                const url = URL.createObjectURL(blob);
                downloadBtn.onclick = () => {
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `interview_${candidateNameInput.value}_${new Date().toISOString().slice(0,19).replace(/:/g, '-')}.webm`;
                    a.click();
                };
                downloadBtn.classList.remove('hidden');
            };
            
            mediaRecorder.start(1000);
            recordBtn.classList.add('hidden');
            stopRecordBtn.classList.remove('hidden');
            
            addEvent('Video recording started', 'info');
        }

        // Stop recording
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                recordBtn.classList.remove('hidden');
                stopRecordBtn.classList.add('hidden');
                addEvent('Video recording stopped', 'info');
            }
        }

        // Generate CSV report
        function generateCSV() {
            const csvContent = [
                'Timestamp,Event,Type',
                ...events.map(e => `"${e.time}","${e.event}","${e.type}"`)
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `interview_report_${candidateNameInput.value || 'candidate'}_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            addEvent('CSV report generated and downloaded', 'info');
        }

        // Event listeners
        startBtn.addEventListener('click', startInterview);
        stopBtn.addEventListener('click', stopInterview);
        recordBtn.addEventListener('click', startRecording);
        stopRecordBtn.addEventListener('click', stopRecording);
        downloadCSVBtn.addEventListener('click', generateCSV);
        
        generateReportBtn.addEventListener('click', () => {
            addEvent('Generating comprehensive report...', 'info');
            setTimeout(() => {
                addEvent('Report generated successfully', 'info');
                alert('Report generated! (In a real implementation, this would generate a PDF report)');
            }, 1000);
        });

        // Initialize the application
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeWebcam();
            addEvent('Interview Proctoring System initialized', 'info');
        });
    </script>
</body>
</html>